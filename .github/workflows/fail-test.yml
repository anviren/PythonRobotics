name: Realistic Python Deps Catastrophe

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  install-deps:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          python3-dev
    
    - name: Create realistic broken project
      run: |
        # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–π requirements.txt
        cat > requirements.txt << 'EOF'
        # Core dependencies - –Ω–æ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏!
        numpy==1.24.0
        pandas==2.0.0
        scipy==1.10.0
        
        # –≠—Ç–æ—Ç –ø–∞–∫–µ—Ç —Ç—Ä–µ–±—É–µ—Ç numpy<1.23, –Ω–æ —É –Ω–∞—Å 1.24.0
        tensorflow==2.13.0
        
        # –≠—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞ –≤–æ–æ–±—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        ml-ai-data-science-pro==2024.1
        
        # –í–µ—Ä—Å–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        transformers==999.999.999
        
        # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å git+https (—á–∞—Å—Ç–æ –ª–æ–º–∞–µ—Ç—Å—è)
        git+https://github.com/psf/black.git@main
        
        # –ü–∞–∫–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç —Å—Ç–∞—Ä—ã–π Python (<3.8)
        legacy-library==0.1.0
        
        # –ü–∞–∫–µ—Ç —Å –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (no auth)
        git+https://github.com/mycompany/private-package.git
        
        # –ü–∞–∫–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å —ç—Ç–æ–π –û–°
        pywin32==305
        
        # –ê–ª—å—Ñ–∞-–≤–µ—Ä—Å–∏—è —Å –±–∞–≥–∞–º–∏
        torch==2.0.0alpha
        
        # –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã
        requests[socks]==2.31.0
        PySocks==1.7.1
        EOF
        
        # –°–æ–∑–¥–∞—ë–º setup.py —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏
        cat > setup.py << 'EOF'
        from setuptools import setup, find_packages
        
        setup(
            name="realistic-broken-project",
            version="0.1.0",
            packages=find_packages(),
            install_requires=[
                "numpy==1.24.0",
                "pandas==2.0.0",
                "tensorflow==2.13.0",
                "this-does-not-exist>=1.0.0",  # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞–∫–µ—Ç
                "scikit-learn@git+https://github.com/scikit-learn/scikit-learn.git@broken-branch",  # –í–µ—Ç–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            ],
            extras_require={
                "dev": [
                    "pytest>=7.0.0",
                    "black==23.0.0",
                    "flake8",  # –±–µ–∑ –≤–µ—Ä—Å–∏–∏ - –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è
                ],
                "gpu": [
                    "torch==2.0.0+cu118",  # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è pip
                ]
            }
        )
        EOF
        
        # –°–æ–∑–¥–∞—ë–º pyproject.toml —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏
        cat > pyproject.toml << 'EOF'
        [build-system]
        requires = [
            "setuptools>=999.999.999",  # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≤–µ—Ä—Å–∏—è
            "wheel>=0.40.0",
            "old-custom-build-tool==0.0.1",  # –ê—Ä—Ö–∏–≤–Ω—ã–π –ø–∞–∫–µ—Ç
        ]
        build-backend = "setuptools.build_meta"
        
        [project]
        name = "realistic-broken-project"
        version = "0.1.0"
        dependencies = [
            "numpy==1.24.0; python_version<'3.10'",  # –ú–∞—Ä–∫–µ—Ä —Å–ª–æ–º–∞–µ—Ç—Å—è –Ω–∞ 3.11
            "pandas==2.0.0; platform_system=='Windows'",  # –ú—ã –Ω–∞ Linux!
        ]
        EOF
    
    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip==23.0  # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è pip
        pip --version
    
    - name: Try to install dependencies (THIS WILL FAIL SPECTACULARLY)
      id: pip_install
      continue-on-error: true  # –õ–æ–≤–∏–º –æ—à–∏–±–∫—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      run: |
        pip install -r requirements.txt 2>&1 | tee pip_errors.log
        
    - name: Install with pipenv (another failure mode)
      if: steps.pip_install.outcome == 'failure'
      run: |
        pip install pipenv==2023.0.0
        pipenv install --skip-lock || true  # –¢–æ–∂–µ —É–ø–∞–¥—ë—Ç, –Ω–æ –ø–æ-–¥—Ä—É–≥–æ–º—É
    
    - name: Debug - Show pip errors
      if: always()
      run: |
        echo "=== PIP ERROR LOG ==="
        cat pip_errors.log 2>/dev/null || echo "No pip error log"
        
        echo "=== ENVIRONMENT ==="
        python --version
        pip --version
        pip list --outdated
        
        echo "=== DISK SPACE ==="
        df -h
        
        echo "=== MEMORY ==="
        free -h
    
    - name: Upload failure artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: pip-failure-logs-${{ matrix.python-version }}
        path: |
          pip_errors.log
          requirements.txt
          setup.py
          pyproject.toml
          ~/.cache/pip/pip.log
        retention-days: 7
    
    - name: Notify about catastrophic failure
      if: failure()
      run: |
        echo "::error::üí• Dependency installation failed catastrophically!"
        echo "::warning::üîç Check pip_errors.log for resolution hints"
        echo "::notice::üì¶ Python ${{ matrix.python-version }} on Ubuntu"

  dependency-audit:
    needs: install-deps
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download failure artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Run dependency audit
        run: |
          echo "::group::Dependency Conflict Analysis"
          echo "üî¥ Found 7 dependency conflicts:"
          echo "  - tensorflow 2.13.0 requires numpy<1.23, but numpy 1.24.0 is installed"
          echo "  - ml-ai-data-science-pro==2024.1 does not exist on PyPI"
          echo "  - transformers==999.999.999 version not found"
          echo "  - private-package.git requires authentication"
          echo "  - legacy-library requires Python<3.8 (current: ${{ matrix.python-version }})"
          echo "  - pywin32 is Windows-only"
          echo "  - setuptools>=999.999.999 version constraint impossible"
          echo "::endgroup::"

  python-version-compatibility:
    needs: install-deps
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Python version compatibility
        run: |
          echo "::warning::üêç Python 3.11 detected - legacy-library==0.1.0 requires Python < 3.8"
          echo "::notice::üìä Python 3.9 is the most compatible version for this dependency set"
